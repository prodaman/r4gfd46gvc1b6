name: Merge EPG XML Files

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * *'  # Ejecuta diariamente a las 12:00 PM UTC

concurrency:
  group: merge-epg
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and merge XML files
        run: |
          # Crear directorio temporal
          mkdir -p files
          
          # Descargar los archivos XML
          curl -L -o files/spain1.xml https://www.open-epg.com/files/spain1.xml
          curl -L -o files/spain2.xml https://www.open-epg.com/files/spain2.xml
          curl -L -o files/spain3.xml https://www.open-epg.com/files/spain3.xml
          curl -L -o files/spain4.xml https://www.open-epg.com/files/spain4.xml

          # Ejecutar el script PHP para fusionar los archivos XML
          php merge_epg.php

          # Comprimir el archivo resultante
          gzip -f merged_epg.xml

      - name: Check if merged file has changed
        id: check_changes
        run: |
          if git diff --quiet merged_epg.xml.gz; then
            echo "No changes detected."
            echo "CHANGED=false" >> $GITHUB_ENV
          else
            echo "Changes detected."
            echo "CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Commit and push merged XML file
        if: env.CHANGED == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add merged_epg.xml.gz
          git commit -m "Update merged EPG file"
          git push

      - name: Upload merged XML as artifact
        if: env.CHANGED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: merged_epg.xml.gz
          path: merged_epg.xml.gz
          retention-days: 7  # Se guarda por 7 d√≠as
