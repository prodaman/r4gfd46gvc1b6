name: Merge EPG XML Files

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 12 * * *'  # Ejecuta diariamente a las 12:00 PM UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download and merge XML files
        run: |
          # Descargar los archivos XML
          mkdir files
          curl -L -o files/spain1.xml https://www.open-epg.com/files/spain1.xml
          curl -L -o files/spain2.xml https://www.open-epg.com/files/spain2.xml
          curl -L -o files/spain3.xml https://www.open-epg.com/files/spain3.xml
          curl -L -o files/spain4.xml https://www.open-epg.com/files/spain4.xml

          # Ejecutar el script PHP para fusionar los archivos XML
          php merge_epg.php

      - name: Set environment variable for merged file
        run: echo "merged_file=merged_epg.xml.gz" >> $GITHUB_ENV

      - name: Check if merged file has changed
        run: |
          git diff --quiet merged_epg.xml.gz || echo "Changes detected in merged_epg.xml.gz" > /dev/null

      - name: Commit and push merged XML file
        run: |
          # Comprobar si el archivo ha cambiado
          if git diff --quiet merged_epg.xml.gz; then
            echo "No changes detected, skipping commit."
          else
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add merged_epg.xml.gz
            git commit -m "Update merged EPG file"
            git push
          fi

      - name: Upload merged XML to repository
        run: |
          # Usamos la API de GitHub para subir el archivo como un artefacto
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -F "file=@merged_epg.xml.gz" \
          https://uploads.github.com/repos/${{ github.repository }}/releases/assets?name=merged_epg.xml.gz
